#!/usr/bin/groovy

node {
    def root = pwd()
    def mvn = tool 'M3'

    stage("Setup") {
        deleteDir()
        sh "mkdir -p bfalg-shape"
        dir("bfalg-shape") {
            git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}"
        }
    }
    def appvers = ""
    dir("bfalg-shape") {
        appvers = sh(script: """git describe --long --tags --always | sed 's/\\./-/'g""", returnStdout: true).trim()
    }
    def appName = "bfalg-shape-${appvers}"

    stage("Archive") {
        sh """
          cp -r bfalg-shape/shape .
          cp -r bfalg-shape/ci .
          cp bfalg-shape/manifest.jenkins.yml .
          cp bfalg-shape/pzsvc-exec.config .
          cp bfalg-shape/environment.yml .
          cp bfalg-shape/Procfile .
          rm -rf bfalg-shape*
        """
        withCredentials([
              [$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.ARTIFACT_STORAGE_CREDS}", usernameVariable: "USER", passwordVariable: "PASS"]
            ]) {
            sh "sed -i "s*CONDA_CHANNEL*`echo $CONDA_CHANNEL | sed -e "s/NEXUSUSER/${USER}/g" | sed -e "s/NEXUSPASS/${PASS}/g"`*g" environment.yml"
        }
        def archiveName="bfalg-shape.tgz"
        sh """
          tar -cvzf ${archiveName} *
        """
        if (false) {
        sh """
          mvn -X --settings ~/.m2/settings.xml deploy:deploy-file -Dfile=${archiveName} \
    		-DrepositoryId=nexus \
    		-Durl="${env.ARTIFACT_STORAGE_DEPLOY_URL}" \
    		-DgroupId="org.venice.beachfront" \
    		-DgeneratePom=false \
    		-Dpackaging=tgz \
    		-Dmaven.repo.local="${root}/.m2/repository" \
    		-DartifactId=bfalg-shape \
    		-Dversion=${appvers} \
    	  """
        }
        sh "rm ${archiveName}"
    }
    stage("Phase One Deploy") {
        if(!fileExists('.cf')) {
            sh "mkdir -p .cf"
        }
        def piazza_api_key = "empty"
        def piazza_url = "https://piazza.${env.PHASE_ONE_PCF_SPACE}.${env.PIAZZA_URL}"
        /*withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: "${params.BEACHFRONT_PIAZZA_AUTH}", usernameVariable: 'TOKEN', passwordVariable: 'unused']]) {
            def keyCurl = sh(script: """curl -s ${piazza_url}/v2/key -u \"${TOKEN}:\"""", returnStdout: true)
            piazza_api_key = sh(script: """echo \"${keyCurl}\"|grep -oE '\\w{8}-\\w{4}-\\w{4}-\\w{4}-\\w{12}'""", returnStdout: true).trim()
            sh """
              if [ -z $piazza_api_key ]; then
                echo "No Piazza API key found"
                exit 1
              fi
            """
        }*/
        withEnv([
          "CF_HOME=.cf"
        ]) {
            withCredentials([
              [$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.PCF_CREDS}", usernameVariable: "CFUSER", passwordVariable: "CFPASS"]
            ]) {
                sh """
                  cf api ${env.PCF_API_ENDPOINT}
                  cf auth ${CFUSER} ${CFPASS}
                  cf target -o ${env.PCF_ORG} -s ${env.PHASE_ONE_PCF_SPACE}
                  cf push ${appName} -f manifest.jenkins.yml --hostname ${appName} -d ${env.PHASE_ONE_PCF_DOMAIN} -b ${env.PYTHON_BUILDPACK_NAME} --no-start -u none
                  cf set-env ${appName} SPACE ${env.PHASE_ONE_PCF_SPACE}
                  cf set-env ${appName} DOMAIN ${env.PHASE_ONE_PCF_DOMAIN}
                  cf set-env ${appName} PZ_API_KEY ${piazza_api_key}
                  cf set-env ${appName} PZ_ADDR ${piazza_url}
                  cf set-env ${appName} PATH /home/vcap/app/.conda/envs/dep_env/bin:/bin:/usr/bin
                  cf restage ${appName}
                """

                try {
                  sh "cf start ${appName}"
                } catch (Exception e) {
                  //sh "cf logs --recent ${appName}"
                  sh "cf delete ${appName} -f"
                  error("Error during application start. Deleting ${appName} and failing the build.")
                }
                sh """
                  cf api ${env.PCF_API_ENDPOINT}
                  cf auth ${CFUSER} ${CFPASS}
                  cf target -o ${env.PCF_ORG} -s ${env.PHASE_ONE_PCF_SPACE}
                """
                def legacyAppNames = sh(script: """cf routes | grep \"bfalg-shape \" | awk '{print \$4}'""", returnStdout: true)
                sh "cf map-route ${appName} ${env.PHASE_ONE_PCF_DOMAIN} --hostname bfalg-shape"
                // Remove legacy applications
                for (Object legacyApp : legacyAppNames.trim().tokenize(',')) {
                    def legacyAppName = legacyApp.toString().trim()
                    if(legacyAppName != appName) {
                        sh "cf unmap-route ${legacyAppName} ${env.PHASE_ONE_PCF_DOMAIN} --hostname ${legacyAppName}"
                        sh "cf delete -f ${legacyAppName}"
                    }
                }
            }
        }
    }
    stage("Phase One Test") {
        
        dir("ci"){
            def piazza_api_key = ""
            withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.BEACHFRONT_PIAZZA_AUTH}", usernameVariable: 'TOKEN', passwordVariable: 'unused']]) {
                def keyCurl = sh(script: """curl -s https://piazza.${env.PHASE_ONE_PCF_SPACE}.${env.PIAZZA_URL}/v2/key -u \"${TOKEN}:\"""", returnStdout: true)
                piazza_api_key = sh(script: """echo \"${keyCurl}\"|grep -oE '\\w{8}-\\w{4}-\\w{4}-\\w{4}-\\w{12}'""", returnStdout: true).trim()
                sh """
                  if [ -z $piazza_api_key ]; then
                    echo "No Piazza API key found"
                    exit 1
                  fi
                """
            }
            sh "export PZ_API_KEY=$piazza_api_key && bash ./test_shape.sh"
        }
        
    }
}
